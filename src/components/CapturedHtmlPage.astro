---
import { correctedLookbookPath, internalUrlRewriteMap } from "../data/legacyLookbook";

export interface Props {
  rawHtml: string;
}

const { rawHtml } = Astro.props;
const hasAutocolumnGallery = /sqs-gallery-design-autocolumns/.test(rawHtml);

function rewriteInternalHref(href: string): string {
  const [pathnameAndSearch, hash = ""] = href.split("#", 2);
  const [pathnameRaw, search = ""] = pathnameAndSearch.split("?", 2);

  let pathname = pathnameRaw;

  // Keep captured internal links inside this rebuilt site.
  if (/^https?:\/\/www\.lovelysunday\.co/i.test(pathname)) {
    pathname = pathname.replace(/^https?:\/\/www\.lovelysunday\.co/i, "") || "/";
  }

  // Browser-normalized legacy double-slash lookbook links need explicit stable targets.
  const legacyDoubleMatch = pathname.match(/^\/lookbook\/\/looks\/([^/?#]+)\/?$/i);
  if (legacyDoubleMatch) {
    pathname = `/lookbook-double/looks/${legacyDoubleMatch[1]}/`;
  } else {
    const slashTerminatedPathname = pathname.endsWith("/") ? pathname : `${pathname}/`;
    if (internalUrlRewriteMap[slashTerminatedPathname]) {
      pathname = correctedLookbookPath(pathname);
    }
  }

  const queryPart = search ? `?${search}` : "";
  const hashPart = hash ? `#${hash}` : "";
  return `${pathname}${queryPart}${hashPart}`;
}

const renderedHtml = rawHtml.replace(
  /<a\b([^>]*?)\bhref=(["'])([^"']+)\2([^>]*)>/gi,
  (_full, beforeHref, quote, hrefValue, afterHref) => {
    const rewrittenHref = rewriteInternalHref(hrefValue);
    return `<a${beforeHref}href=${quote}${rewrittenHref}${quote}${afterHref}>`;
  },
);
---

<Fragment set:html={renderedHtml} />

{
  hasAutocolumnGallery && (
    <>
      <style>
        body.collection-type-gallery .site-page--gallery-list .gallery-wrapper {
          max-width: min(1440px, 100%);
          margin: 0 auto;
          padding-inline: clamp(14px, 2.2vw, 30px);
        }

        body.collection-type-gallery .site-page--gallery-list .slides.sqs-gallery-design-autocolumns {
          display: grid !important;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: clamp(12px, 1.5vw, 20px);
          height: auto !important;
          align-items: start;
        }

        body.collection-type-gallery .site-page--gallery-list .sqs-gallery-design-autocolumns-slide {
          position: relative !important;
          inset: auto !important;
          width: 100% !important;
          height: auto !important;
          margin: 0 !important;
          overflow: hidden;
          opacity: 0;
          transform: translate3d(0, 14px, 0);
          transition:
            opacity 220ms ease-out,
            transform 220ms ease-out;
          will-change: opacity, transform;
        }

        body.collection-type-gallery .site-page--gallery-list .sqs-gallery-design-autocolumns-slide.is-visible {
          opacity: 1;
          transform: translate3d(0, 0, 0);
        }

        body.collection-type-gallery .site-page--gallery-list .sqs-gallery-design-autocolumns-slide {
          grid-column: 1 / -1;
        }

        body.collection-type-gallery .site-page--gallery-list .sqs-gallery-design-autocolumns-slide.is-half-span {
          grid-column: auto;
        }

        body.collection-type-gallery .site-page--gallery-list .sqs-gallery-design-autocolumns-slide img {
          display: block;
          width: 100% !important;
          height: auto !important;
          object-fit: cover;
        }

        @media (max-width: 800px) {
          body.collection-type-gallery .site-page--gallery-list .slides.sqs-gallery-design-autocolumns {
            grid-template-columns: 1fr;
            gap: 14px;
          }

          body.collection-type-gallery .site-page--gallery-list .sqs-gallery-design-autocolumns-slide {
            grid-column: auto;
          }
        }

        @media (prefers-reduced-motion: reduce) {
          body.collection-type-gallery .site-page--gallery-list .sqs-gallery-design-autocolumns-slide {
            opacity: 1;
            transform: none;
            transition: none;
          }
        }
      </style>

      <script is:inline>
        (() => {
          const gallerySlides = Array.from(
            document.querySelectorAll(
              ".site-page--gallery-list .slides.sqs-gallery-design-autocolumns .sqs-gallery-design-autocolumns-slide",
            ),
          );
          if (gallerySlides.length === 0) return;

          // Swap low-res thumbnail URLs with captured originals for wide layouts.
          for (const slide of gallerySlides) {
            const img = slide.querySelector("img[data-src]");
            if (!img) continue;
            const source = img.getAttribute("data-src");
            if (!source) continue;
            if (img.getAttribute("src") !== source) {
              img.setAttribute("src", source);
            }
          }

          const getOrientation = (slide) => {
            const img = slide.querySelector("img");
            if (!img) return "unknown";

            const dimensions = img.getAttribute("data-image-dimensions") || "";
            const match = dimensions.match(/(\\d+)x(\\d+)/i);
            if (!match) return "unknown";

            const width = Number(match[1]);
            const height = Number(match[2]);
            if (!Number.isFinite(width) || !Number.isFinite(height) || width <= 0 || height <= 0) {
              return "unknown";
            }

            if (Math.abs(width - height) <= 24) return "square";
            return height > width ? "portrait" : "landscape";
          };

          // Build 50/50 rows only when adjacent slides share orientation.
          // Mixed orientation pairs are promoted to full-width to keep visual balance.
          for (const slide of gallerySlides) {
            slide.classList.remove("is-half-span");
          }

          let index = 0;
          if (gallerySlides.length > 0) {
            index = 1; // Keep a lead full-width image before paired rows.
          }

          while (index < gallerySlides.length) {
            const current = gallerySlides[index];
            const next = gallerySlides[index + 1];

            if (!next) {
              index += 1;
              continue;
            }

            const currentOrientation = getOrientation(current);
            const nextOrientation = getOrientation(next);
            const isBalancedPair =
              currentOrientation !== "unknown" &&
              nextOrientation !== "unknown" &&
              currentOrientation === nextOrientation;

            if (isBalancedPair) {
              current.classList.add("is-half-span");
              next.classList.add("is-half-span");
              index += 2;
              continue;
            }

            index += 1;
          }

          const revealSlide = (slide) => slide.classList.add("is-visible");
          if (!("IntersectionObserver" in window)) {
            gallerySlides.forEach(revealSlide);
            return;
          }

          const observer = new IntersectionObserver(
            (entries, obs) => {
              for (const entry of entries) {
                if (!entry.isIntersecting) continue;
                entry.target.classList.add("is-visible");
                obs.unobserve(entry.target);
              }
            },
            { root: null, rootMargin: "0px 0px -8% 0px", threshold: 0.12 },
          );

          gallerySlides.forEach((slide) => observer.observe(slide));
        })();
      </script>
    </>
  )
}
