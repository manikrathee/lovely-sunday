---
import "../styles/vars.css";
import "../styles/content.css";
import "../styles/layout.css";
import "../styles/components/site-shell.css";
import "astro-breadcrumbs/breadcrumbs.css";

import { Head } from "astro-capo";
import { SEO } from "astro-seo";
import { Breadcrumbs } from "astro-breadcrumbs";
import { GoogleAnalytics } from "@astrolib/analytics";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { getRouteSeoMeta } from "../lib/routeSeo";

export interface Props {
    title?: string;
    description?: string;
    noindex?: boolean;
    breadcrumbs?: boolean;
    ogImagePath?: string;
    children?: any;
}

const {
    title,
    description,
    noindex = false,
    breadcrumbs = true,
    ogImagePath,
} = Astro.props;

const siteName = "Lovely Sunday";
const siteDescription =
    "A minimalist, image-first photoblog built with Astro and the Clay theme.";
const routeSeo = getRouteSeoMeta(Astro.url.pathname);
const normalizedPath = Astro.url.pathname.replace(/^\/|\/$/g, "");
const resolvedOgPath =
    ogImagePath || (normalizedPath.length > 0 ? normalizedPath : "index");
const canonical = routeSeo?.canonical || Astro.url.href;
const ogImage = new URL(
    `/open-graph/${resolvedOgPath}.png`,
    Astro.site ?? Astro.url,
).href;
const gaMeasurementId = import.meta.env.PUBLIC_GA_MEASUREMENT_ID;
const twitterHandle = import.meta.env.PUBLIC_TWITTER_HANDLE;
const showBreadcrumbs = breadcrumbs && Astro.url.pathname !== "/";
const resolvedTitle = routeSeo?.title || title || siteName;
const resolvedDescription = routeSeo?.description || description || siteDescription;
const resolvedOgImage = routeSeo?.openGraph.image || ogImage;
const resolvedOgUrl = routeSeo?.openGraph.url || canonical;
const resolvedRobots = routeSeo?.robots || undefined;
const resolvedNoIndex = noindex || (resolvedRobots?.includes("noindex") ?? false);
---

<!doctype html>
<html lang="en">
    <Head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet" />

        <SEO
            title={resolvedTitle}
            titleDefault={siteName}
            titleTemplate={routeSeo?.title ? undefined : `%s | ${siteName}`}
            description={resolvedDescription}
            canonical={canonical}
            noindex={resolvedNoIndex}
            nofollow={resolvedNoIndex}
            openGraph={{
                basic: {
                    title: routeSeo?.openGraph.title || resolvedTitle,
                    type: routeSeo?.openGraph.type || "website",
                    image: resolvedOgImage,
                    url: resolvedOgUrl,
                },
                optional: {
                    description:
                        routeSeo?.openGraph.description || resolvedDescription,
                    siteName,
                },
            }}
            twitter={{
                card: routeSeo?.twitter.card || "summary_large_image",
                title: routeSeo?.twitter.title || resolvedTitle,
                description: routeSeo?.twitter.description || resolvedDescription,
                image: routeSeo?.twitter.image || resolvedOgImage,
                creator: twitterHandle || undefined,
                site: twitterHandle || undefined,
            }}
        />

        {resolvedRobots && <meta name="robots" content={resolvedRobots} />}

        {routeSeo?.jsonLd.map((entry) => (
            <script is:inline type="application/ld+json" set:html={entry} />
        ))}

        <script is:inline>
            const theme = (() => {
                if (
                    typeof localStorage !== "undefined" &&
                    localStorage.getItem("theme")
                ) {
                    return localStorage.getItem("theme");
                }
                return "light";
            })();

            if (theme === "dark") {
                document.documentElement.setAttribute("data-theme", "dark");
            } else {
                document.documentElement.removeAttribute("data-theme");
            }
        </script>
    </Head>
    <body class="site-wrapper">
        <div class="site-content-shell">
            <Header title={title} />

            {showBreadcrumbs && (
                <div class="site-breadcrumbs">
                    <Breadcrumbs indexText="Home" />
                </div>
            )}

            <main id="site-main" class="site-main">
                <div id="swup" class="transition-fade">
                    <slot />
                </div>
            </main>
        </div>

        <Footer />

        <script>
            import Swup from "swup";
            import HeadPlugin from "@swup/head-plugin";

            document.addEventListener("DOMContentLoaded", () => {
                new Swup({
                    containers: ["#swup"],
                    cache: true,
                    animationSelector: "[class*='transition-']",
                    plugins: [new HeadPlugin()],
                });
            });
        </script>

        <script is:inline>
            // Scroll reveal for post cards
            (function () {
                if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

                var observer = new IntersectionObserver(
                    function (entries) {
                        entries.forEach(function (entry) {
                            if (entry.isIntersecting) {
                                entry.target.classList.add('is-visible');
                                observer.unobserve(entry.target);
                            }
                        });
                    },
                    { threshold: 0.1, rootMargin: '0px 0px -40px 0px' }
                );

                document.querySelectorAll('.post-card').forEach(function (card) {
                    observer.observe(card);
                });
            })();
        </script>

        {gaMeasurementId && <GoogleAnalytics id={gaMeasurementId} />}
    </body>
</html>
